<html>
<head>
	<title>CoinPop</title>
	<link href="https://fonts.googleapis.com/css?family=Heebo:300,400,500,700,900" rel="stylesheet">
	<link href='https://raw.github.com/daneden/animate.css/master/animate.css' rel="stylesheet">
	<meta charset="utf-8"/>
	<style>
	*{
		-webkit-margin-before: 0em;
		-webkit-margin-after: 0em;
	}
	body{
		margin:0;
		padding:0;
		background:#1b1e28;
		color:white;
		font-family:"Heebo";
	}
	iframe{
		width:100% !important;
		flex:2 !important;
	}
	#twitter_box iframe{
		height:100% !important;
	}
	a:hover{
		cursor:pointer;
	}
	[data-box] *{
		pointer-events: none;
	}
	.header{
		font-weight:300;
		padding-left:10px;
		padding-top:5px;
		padding-bottom:2px;
		padding-right:10px;
		font-size:16px;
		overflow:hidden;
	}
	.green{
		color:#27ae60;
	}
	.red{
		color:#bc3131;
	}
	.flex{
		display:flex;
	}
	.flex-50 > div{
		flex:50%;
	}
	.flex-75 > div{
		flex:75%;
	}
	.flex-25 > div{
		flex:25%;
	}
	.flex-20 > div{
		flex:20%;
	}
	.pad-all-small{
		padding:5px;
	}
	.content{
		margin:0 auto;
		height:125vh;
		overflow:none;
		display:flex;
		flex-direction: column;
	}
	a{
		color:white;
		text-decoration: none;
	}
	.block{
		width:100%;
	}
	.box{
		border-radius:6px;
		overflow:hidden;
		flex-direction: column;
		box-sizing:border-box;
	}
	.box:hover{
		cursor:pointer;
		opacity:0.8;
	}
	.box,.box:hover{
		transition:.25s all;
	}
	.bg-light{
		background:#202733;
	}
	.bg-dark{
		background:#1c212c;
	}
	.flex-horizontal{
		flex-direction:row;
	}
	.flex-vertical{
		flex-direction:column;
	}
	.pad-all-custom{
		padding-top:10px;
		padding-left:5px;
		padding-right:5px;
	}
	.pad-all-custom:first-child{
		padding-left:0px !important;
	}
	.pad-all-custom:last-child{
		padding-right:0px !important;
	}
	.flex-fillRest{
		flex:2;
	}
	.flex-center{
		align-items:center;
		justify-content: center;
	}
	.price{
		font-weight:400;
		font-size:24px;
	}
	.deselected{
		color:#45484f;
	}
	.pad-all-large{
		padding:10px;
	}
	.bg-tab{
		
	}
	.hidden{
		opacity:0;
	}
	.selectedBox{
		box-shadow:0px 0px 5px rgba(60, 220, 173, 0.5);
	}
</style>
</head>
<body>

	<div class="content">
		<div style="margin:20px" class="flex flex-vertical">
			<div class="flex" style="flex:5%;align-items:flex-start;">
				<img src="coinpopnewlogo.svg" height="30px" style="padding-left:10px;">
			</div>
			<div class="flex flex-20" style="flex:10%;padding:5px;">
				<div class="pad-all-small flex">
					<div class="box flex bg-light block" data-box="BTC">
						<h3 class="header bg-dark">
							Bitcoin
						</h3>
						<p class="pad-all-small flex flex-fillRest flex-center">
							<span id="BTC-price" class="price"></span>&nbsp;&nbsp;USD
							&nbsp;&nbsp;
							<span id="BTC-percentage" class="percentage">ðŸ•˜</span>
						</p>
					</div>
				</div>
				<div class="pad-all-small flex">
					<div class="box flex bg-light block" data-box="ETH">
						<h3 class="header bg-dark">
							Ethereum
						</h3>
						<p class="pad-all-small flex flex-fillRest flex-center">
							<span id="ETH-price" class="price"></span>&nbsp;&nbsp;USD
							&nbsp;&nbsp;
							<span id="ETH-percentage" class="percentage">ðŸ•˜</span>
						</p>
					</div>
				</div>
				<div class="pad-all-small flex">
					<div class="box flex bg-light block" data-box="LTC">
						<h3 class="header bg-dark">
							Litecoin
						</h3>
						<p class="pad-all-small flex flex-fillRest flex-center">
							<span id="LTC-price" class="price"></span>&nbsp;&nbsp;USD
							&nbsp;&nbsp;
							<span id="LTC-percentage" class="percentage">ðŸ•˜</span>
						</p>
					</div>
				</div>
				<div class="pad-all-small flex">
					<div class="box flex bg-light block" data-box="XRP">
						<h3 class="header bg-dark">
							Ripple
						</h3>
						<p class="pad-all-small flex flex-fillRest flex-center">
							<span id="XRP-price" class="price"></span>&nbsp;&nbsp;USD
							&nbsp;&nbsp;
							<span id="XRP-percentage" class="percentage">ðŸ•˜</span>
						</p>
					</div>
				</div>
				<div class="pad-all-small flex">
					<div class="box flex bg-light block" data-box="BCH">
						<h3 class="header bg-dark">
							Bitcoin Cash
						</h3>
						<p class="pad-all-small flex flex-fillRest flex-center">
							<span id="BCH-price" class="price"></span>&nbsp;&nbsp;USD
							&nbsp;&nbsp;
							<span id="BCH-percentage" class="percentage">ðŸ•˜</span>
						</p>
					</div>
				</div>
			</div>


			<div class="flex" style="flex:85%;padding-left:5px;padding-right:5px;">
				<div class="flex pad-all-small flex-vertical" style="flex:60%;">
					<div class="box bg-light block pad-all-large" style="flex:50%;position:relative;">
						<canvas id="graph" class="hidden" style="position:absolute;left:0;right:0;height:auto !important;"></canvas>
					</div>
					<div class="flex flex-horizontal" style="flex:50%">
						<div class="pad-all-custom flex" style="flex:60%;">
							<div class="box flex bg-light block">
								<h3 class="header bg-dark flex deselected">
									Discussion
								</h3>
								<div style="flex:2;overflow-y:scroll;">
									<div id="disqus_thread" class="pad-all-large flex flex-fillRest"></div>
								</div>
							</div>
						</div>
						<div class="pad-all-custom flex" style="flex:40%">
							<div class="box bg-light block">
								<h3 class="header bg-dark deselected">
									Information
								</h3>

								
							</div>
						</div>
					</div>
				</div>
				<div class="flex pad-all-small" style="flex:40%">
					<div class="box bg-light block">
						<h3 class="header bg-dark">
							<a class="deselected" id="twitter">Twitter Feed</a>
						</h3>

						<div id="twitter_box" class="flex">
							<a class="twitter-timeline block flex-fillRest" href="https://twitter.com/gocoinpop/lists/coin-news&chrome=transparent noheader nofooter" data-chrome="nofooter noheader transparent" data-widget-id="943248664046243840"></a>
						</div>

						<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

						<script>
						(function() { // DON'T EDIT BELOW THIS LINE
							var d = document, s = d.createElement('script');
							s.src = 'https://coinpop.disqus.com/embed.js';
							s.setAttribute('data-timestamp', +new Date());
							(d.head || d.body).appendChild(s);
						})();
					</script>
					<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
				</div>
			</div>
		</div>
	</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bluebird/3.5.1/bluebird.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>
<script src="https://js.pusher.com/4.2/pusher.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js"></script>
<script type="text/javascript" src="https://github.com/nagix/chartjs-plugin-streaming/releases/download/v1.2.0/chartjs-plugin-streaming.min.js"></script>
<script>

	setTimeout(function(){
		el('graph').classList.remove('hidden');
		el('graph').classList.add('animated');
		el('graph').classList.add('fadeIn');
	},1500)
	var currentTicker;
	var tickers = {
		'BTC': {
			ticker: 'BTC',
			buffer: []
		},
		'ETH': {
			ticker: 'ETH',
			buffer: []
		},
		'LTC': {
			ticker: 'LTC',
			buffer: []
		},
		'XRP': {
			ticker: 'XRP',
			channel: 'XRPUSDT',
			digits: 4,
			buffer: []
		},
		'BCH': {
			ticker: 'BCH',
			buffer: []
		}
	}

	function apiRequest(url, raw){
		var request = new XMLHttpRequest();

		return new Promise(function(res,rej){
			request.open('GET', url, true);

			request.onload = function() {
				if (request.status >= 200 && request.status < 400) {
					if(raw){
						return res(request.responseText)
					}
					res(JSON.parse(request.responseText));
				} else {
					alert("HTTP Error");
				}
			};

			request.onerror = function() {
				alert("HTTP Error");
			};

			request.send();
		})

	}

	for(var ticker in tickers){
		tickers[ticker].buffer = [];
		tickers[ticker].canReceive = true;
	}

	var connection;
	
	function initializeSocket(){
		for(var ticker in tickers){
			connection.send(JSON.stringify({
			  "method": "subscribeTicker",
			  "params": {
			    "symbol": (tickers[ticker].channel || tickers[ticker].ticker+"USD")
			  },
			  "id": (Math.random()%1000000)+10000
			}))
		}

	}

	function receiveMessage(data){

		var data = JSON.parse(data.data);

		if(data.channel == "ticker"){
			canReceive = false;
			var to = "USD";
			var from = data.data.symbol.replace("USDT",'').replace("USD",'');
			var price = data.data.ask;
			var date = moment(data.data.timestamp);

			if(!tickers[from].canReceive){
				return;
			}

			tickers[from].canReceive = false;
			setTimeout(function(){
				tickers[from].canReceive = true;
			},2000)

			var changePercentage = ((price-data.data.open)/data.data.open)*100;
			tickers[from].buffer.push({
				x: date,
				y: price
			})

			var digitCount = tickers[from].digits || 2;
			var format = '0,0.'
			for(var i=0;i<digitCount;i++){
				format = format+"0";
			}
			el(from+'-price').innerHTML = numeral(parseFloat(price)).format(format);
			el(from+'-percentage').innerHTML = changePercentage.toFixed(2)+" %";
			if(changePercentage > 0){
				el(from+"-percentage").classList.remove('red')
				el(from+"-percentage").classList.add('green')
			}else{
				el(from+"-percentage").classList.remove('green')
				el(from+"-percentage").classList.add('red')
			}

		}
		
	}
	
	var el = function(id){ return document.getElementById(id) };

	var chartConfig = {

		type: 'line',
		data: {
			datasets: [{
				data: [],
				type: "line",
				borderColor: 'rgb(60, 220, 173)', // line color
				backgroundColor: 'rgba(60, 220, 173, 0.5)', // fill color
				fill: true,                      // no fill
				lineTension: 0
			}]
		},
		options: {
			layout: {
	            padding: {
	                left: 0,
	                right: 0,
	                top: 0,
	                bottom: 0
	            }
	        },
			scaleShowLabels : true,
	    	responsive: true,
	    	maintainAspectRatio: false,
	    	legend: {
	    		display: false
	    	},
	    	tooltips: {
	    		enabled: true
	    	},
	    	title: {
	            text: '', // chart title
	            display: false
	        },
	        scales: {
	        	xAxes: [{
	                type: 'realtime', // auto-scroll on X axis
	                display: true
	            }],
	            yAxes: [{
	            	position: 'right',
	            	ticks: {
		                userCallback: function(label, index, labels) {
		                    var split = label.toString().split('.');
		                    if(split[1] && split[1].length == 1) {
		                       	return parseFloat(split[0]+'.'+split[1]+'0');
		                    }else{
		                    	return parseFloat(label);
		                    }
		                },
		             }
	            }]
	        },
	        tooltips: {
	        	intersect: false
	        },
	        hover: {
	        	mode: 'nearest',
	        	intersect: false
	        },
	        elements: {
	        	point: {
	        		radius: 1
	        	} 
	        },
	        plugins: {
	        	streaming: {
	                duration: 5*60*1000, // display data for the latest 300000ms (5 mins)
	                delay: 0,

	                onRefresh: function(chart) { // callback on chart update interval
	                	if(!currentTicker){
	                		return;
	                	}
	                	Array.prototype.push.apply(chart.data.datasets[0].data, tickers[currentTicker].buffer);
	                	chart.data.datasets[0].data.sort(function(a, b) {
	                		return a.x - b.x;
	                	});
	                	el('graph').classList.remove('hidden')

	                	tickers[currentTicker].buffer = [];
	                }
	            }
	        }
	    }
	}

	var ctx = document.querySelector('canvas').getContext('2d');

	var chart = new Chart(ctx, chartConfig);

	function selectCurrency(ticker){
		el('graph').classList.add('hidden')
		chart.data.datasets[0].data = [];
		chart.update();

		currentTicker = ticker;
		var boxes = document.querySelectorAll('[data-box]');
		for(var i=0;i<boxes.length;i++){
			boxes[i].classList.remove('selectedBox');
		}
		console.log(ticker);
		document.querySelector('[data-box="'+ticker+'"]').classList.add('selectedBox');
		apiRequest("https://min-api.cryptocompare.com/data/histominute?fsym="+ticker+"&tsym=USD&limit=20&e=HitBTC")
		.then(function(res){
			for(var j=0;j<res.Data.length;j++){
				tickers[currentTicker].buffer.push({
					x: moment(res.Data[j].time*1000),
					y: res.Data[j].close
				})
			}
			Array.prototype.push.apply(chart.data.datasets[0].data, tickers[currentTicker].buffer);
			chart.data.datasets[0].data.sort(function(a, b) {
				return a.x - b.x;
			});
			tickers[currentTicker].buffer = [];
		})
	}

	window.onload = function(){

		/*el('twitter').addEventListener('click', function(){
			el('twitter').classList.remove('deselected');
			el('discuss').classList.add('deselected');
			el('disqus_thread').setAttribute('style','display:none');
			el('twitter_box').setAttribute('style','');
		}, true)

		el('discuss').addEventListener('click', function(){
			el('discuss').classList.remove('deselected')
			el('twitter').classList.add('deselected')
			el('disqus_thread').setAttribute('style','');
			el('twitter_box').setAttribute('style','display:none');
		}, true)*/

		var boxes = document.querySelectorAll('[data-box]');
		for(var i=0;i<boxes.length;i++){
			boxes[i].addEventListener('click', function(event){
				console.log(event.target);
				selectCurrency(event.target.getAttribute('data-box'))
			})
		}
		
		selectCurrency('BTC')
		connection = new WebSocket('wss://api.hitbtc.com/api/2/ws');
		connection.onopen = initializeSocket;
		connection.onmessage = receiveMessage;
	}
</script>
</body>
</html>